import {Session} from "uu_oidcg01";
import * as Plus4U5 from "uu_plus4u5g01";

let Calls = {
  loadActivities(dtoIn) {
    Plus4U5.Common.Calls.getPersonalRoleUri(
      uri => {
        let commandUri = 'https://api.plus4u.net/ues/wcp/ues/digitalworkspace/digitalworkspace/UESDigitalWorkspace/getActiveRecordList';
        Plus4U5.Common.Calls.call('get', commandUri, { uesuri: uri, query: 'isUnread=true AND pending=false' }, dtoIn);
      },
      dtoIn.fail
    );
  },

  loadNavigator: (dtoIn) => {
    Plus4U5.Common.Calls.getPersonalRoleUri(
      uri => Plus4U5.Common.Calls.getPropertyValue(uri + 'VAR.UES.COR.SYSTEM_NAVIGATOR', dtoIn.done, dtoIn.fail),
      dtoIn.fail
    );
  },

  loadNavigationBar: (dtoIn) => {
    // we can get either direct link to navigationBarUri (simple navigation bar, only one row, on organizational units)
    if (dtoIn.data.navigationBarUri) {
      Plus4U5.Common.Calls.getPropertyValue(
        dtoIn.data.navigationBarUri,
        dtoOut => {
          typeof dtoIn.done === "function" && dtoIn.done({ data: [Plus4U5.Common.Tools.base64DecodeUnicode(dtoOut.dataHandler).data] });
        },
        dtoIn.fail
      );
    } else {
      let mainEntityUri = dtoIn.data.mainEntityUri;

      let territoryPart = mainEntityUri.split(':')[1];
      let acrUri = "ues:" + territoryPart + ":" + Session.currentSession.getIdentity().uuIdentity;

      let calls = ["UU.BEM/NAVIGATION_BAR_1/PORTAL", "UU.BEM/NAVIGATION_BAR_2/PORTAL"].map(code => {
        return new Promise((resolve, reject) => {
          Plus4U5.Common.Calls.getPropertyValue(
            acrUri + ":" + code,
            value => resolve(Plus4U5.Common.Tools.base64DecodeUnicode(value.dataHandler).data),
            reject
          );
        });
      });

      Promise.all(calls).then(
        values => typeof dtoIn.done === "function" && dtoIn.done({ data: values }),
        dtoIn.fail
      );
    }
  }
};

export default Calls;
